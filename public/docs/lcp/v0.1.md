# LoanCast Protocol v0.1 - Technical Implementation

## Contract Addresses

### Base Mainnet (chainId: 8453)
- **USDC (Native)**: `0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913` ⚠️ Not USDbC
- **LoanRegistry**: `0x...` (pending deployment)
- **RepaymentRouter**: `0x...` (pending deployment)
- **AgentRegistry**: `0x...` (pending deployment)

### Base Sepolia Testnet (chainId: 84532)
- **USDC (Test)**: `0x...` (pending)
- **LoanRegistry**: `0x...` (pending)
- **RepaymentRouter**: `0x...` (pending)

## EIP-712 Domain Separator

```solidity
bytes32 constant DOMAIN_TYPEHASH = keccak256(
    "EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"
);

function domainSeparator() public view returns (bytes32) {
    return keccak256(abi.encode(
        DOMAIN_TYPEHASH,
        keccak256("LoanCast Protocol"),
        keccak256("1"),
        8453, // Base mainnet chainId
        address(this)
    ));
}
```

## Loan Intent Types

```solidity
// EIP-712 type definitions
bytes32 constant LOAN_INTENT_TYPEHASH = keccak256(
    "LoanIntent(address borrower,uint256 principal_usdc_6,uint256 repay_usdc_6,uint32 due_ts,uint256 nonce)"
);

struct LoanIntent {
    address borrower;
    uint256 principal_usdc_6;  // 6 decimals
    uint256 repay_usdc_6;      // 6 decimals
    uint32 due_ts;              // Unix timestamp
    uint256 nonce;              // Replay protection
}
```

## Deterministic Loan ID Generation

```solidity
function computeLoanId(
    address borrower,
    uint256 nonce,
    uint256 principal_usdc_6,
    uint256 repay_usdc_6,
    uint32 due_ts
) public pure returns (bytes32) {
    return keccak256(abi.encode(
        borrower,
        nonce,
        principal_usdc_6,
        repay_usdc_6,
        due_ts
    ));
}
```

## Repayment Router Flow (v0.1)

Single-shot repayment only in v0.1:

```solidity
function repay(bytes32 loanId) external {
    Loan memory loan = registry.getLoan(loanId);
    require(loan.status == Status.Funded, "Not funded");
    require(block.timestamp <= loan.due_ts + GRACE_PERIOD, "Past grace period");
    
    // Transfer full repayment amount
    IERC20(USDC).transferFrom(msg.sender, loan.lender, loan.repay_usdc_6);
    
    // Update registry
    registry.markRepaid(loanId);
    
    emit LoanRepaid(loanId, msg.sender, loan.repay_usdc_6);
}
```

## Agent Registration ABI

```solidity
interface IAgentRegistry {
    function registerAgent(
        uint256 agentFid,
        address wallet,
        bytes calldata policy
    ) external returns (uint256 agentId);
    
    function updatePolicy(
        uint256 agentId,
        bytes calldata newPolicy
    ) external;
    
    function deactivateAgent(uint256 agentId) external;
}
```

## Test Vectors

### Valid Loan Intent
```json
{
  "borrower": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEd1",
  "principal_usdc_6": 100000000,
  "repay_usdc_6": 102000000,
  "due_ts": 1735689600,
  "nonce": 1,
  "expectedLoanId": "0x..."
}
```

### EIP-712 Signature
```json
{
  "domain": {
    "name": "LoanCast Protocol",
    "version": "1",
    "chainId": 8453,
    "verifyingContract": "0x..."
  },
  "message": {
    "borrower": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEd1",
    "principal_usdc_6": 100000000,
    "repay_usdc_6": 102000000,
    "due_ts": 1735689600,
    "nonce": 1
  },
  "signature": "0x..."
}
```

## Important Notes

1. **USDC Address**: Always use native USDC (`0x833589...2913`), never USDbC
2. **Chain ID**: Base mainnet is `8453`, Base Sepolia is `84532`
3. **Repayment**: v0.1 only supports single-shot full repayment
4. **Agent Wallets**: Must be ERC-4337 compliant smart accounts
5. **FID Mapping**: Farcaster FIDs map deterministically to Ethereum addresses

## References

- [Base Network Docs](https://docs.base.org)
- [Native USDC on Base](https://docs.base.org/docs/tokens/list)
- [EIP-712 Specification](https://eips.ethereum.org/EIPS/eip-712)
- [ERC-4337 Account Abstraction](https://eips.ethereum.org/EIPS/eip-4337)
- [Farcaster Contracts](https://docs.farcaster.xyz/reference/contracts/reference)

---

*LCP v0.1 Technical Docs | Updated: December 2024*